---
// No server-side processing needed for the registration form page.
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Register</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f0f2f5; padding: 20px; }
    form { display: flex; flex-direction: column; width: 300px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); background-color: white; }
    input { padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 10px; border: none; border-radius: 4px; background-color: #28a745; color: white; cursor: pointer; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #message { margin-top: 10px; }
    a { margin-top: 15px; color: #007bff; text-decoration: none; }
    
    /* Password strength indicator styles */
    .password-wrapper { position: relative; margin-bottom: 15px; }
    .strength-meter { height: 4px; border-radius: 2px; transition: all 0.3s; margin-top: 5px; background-color: #e0e0e0; }
    .strength-meter.weak { width: 25%; background-color: #f44336; }
    .strength-meter.fair { width: 50%; background-color: #ff9800; }
    .strength-meter.good { width: 75%; background-color: #ffc107; }
    .strength-meter.strong { width: 90%; background-color: #4caf50; }
    .strength-meter.very_strong { width: 100%; background-color: #2e7d32; }
    
    .strength-text { font-size: 12px; margin-top: 5px; min-height: 18px; }
    .strength-text.weak { color: #f44336; }
    .strength-text.fair { color: #ff9800; }
    .strength-text.good { color: #ffc107; }
    .strength-text.strong { color: #4caf50; }
    .strength-text.very_strong { color: #2e7d32; }
    
    .password-details { font-size: 11px; color: #666; margin-top: 5px; }
    .password-details ul { margin: 5px 0; padding-left: 20px; }
    .password-details li { margin: 2px 0; }
    .password-details .check { color: #4caf50; }
    .password-details .cross { color: #f44336; }
  </style>
</head>
<body>
  <h1>Create Account</h1>
  <form id="register-form">
    <input type="text" id="username" placeholder="Username" required />
    <input type="email" id="email" placeholder="Email" required />
    
    <div class="password-wrapper">
      <input type="password" id="password" placeholder="Password (min 12 characters)" required />
      <div id="strength-meter" class="strength-meter"></div>
      <div id="strength-text" class="strength-text"></div>
      <div id="password-details" class="password-details"></div>
    </div>
    
    <button type="submit" id="submit-btn">Register</button>
  </form>
  <p id="message"></p>
  <a href="/">Already have an account? Log in</a>

  <script>
    let currentStrength: any = null;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const strengthMeter = document.getElementById('strength-meter') as HTMLDivElement;
    const strengthText = document.getElementById('strength-text') as HTMLDivElement;
    const passwordDetails = document.getElementById('password-details') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    // Debounce function to avoid too many API calls
    function debounce(func: Function, wait: number) {
      let timeout: number;
      return function executedFunction(...args: any[]) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    async function checkPasswordStrength(password: string) {
      if (password.length === 0) {
        strengthMeter.className = 'strength-meter';
        strengthText.textContent = '';
        passwordDetails.innerHTML = '';
        currentStrength = null;
        return;
      }

      try {
        const response = await fetch('http://localhost:8080/api/check-password-strength', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });

        if (response.ok) {
          const strength = await response.json();
          currentStrength = strength;
          
          // Update strength meter
          strengthMeter.className = `strength-meter ${strength.level}`;
          strengthText.className = `strength-text ${strength.level}`;
          strengthText.textContent = strength.feedback;

          // Update password requirements checklist
          const detailsHTML = `
            <ul>
              <li class="${strength.length >= 12 ? 'check' : 'cross'}">
                ${strength.length >= 12 ? '✓' : '✗'} At least 12 characters
              </li>
              <li class="${strength.has_upper ? 'check' : 'cross'}">
                ${strength.has_upper ? '✓' : '✗'} Uppercase letters
              </li>
              <li class="${strength.has_lower ? 'check' : 'cross'}">
                ${strength.has_lower ? '✓' : '✗'} Lowercase letters
              </li>
              <li class="${strength.has_numbers ? 'check' : 'cross'}">
                ${strength.has_numbers ? '✓' : '✗'} Numbers
              </li>
              <li class="${strength.has_symbols ? 'check' : 'cross'}">
                ${strength.has_symbols ? '✓' : '✗'} Special symbols
              </li>
              <li class="${!strength.is_common ? 'check' : 'cross'}">
                ${!strength.is_common ? '✓' : '✗'} Not a common password
              </li>
            </ul>
          `;
          passwordDetails.innerHTML = detailsHTML;
        }
      } catch (error) {
        console.error('Error checking password strength:', error);
      }
    }

    const debouncedCheck = debounce(checkPasswordStrength, 300);
    passwordInput.addEventListener('input', (e) => {
      debouncedCheck((e.target as HTMLInputElement).value);
    });

    (document.getElementById('register-form') as HTMLFormElement).addEventListener('submit', async (event) => {
      event.preventDefault();
      const username = (document.getElementById('username') as HTMLInputElement).value;
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = passwordInput.value;
      const messageEl = document.getElementById('message') as HTMLParagraphElement;

      // Check if password is strong enough before submitting
      if (currentStrength && currentStrength.level === 'weak') {
        messageEl.textContent = 'Please choose a stronger password';
        messageEl.style.color = 'red';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';

      try {
        const response = await fetch('http://localhost:8080/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password }),
        });

        if (response.ok) {
          messageEl.textContent = 'Registration successful! Redirecting to login...';
          messageEl.style.color = 'green';
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        } else {
          const error = await response.json();
          messageEl.textContent = `Registration failed: ${error.message}`;
          messageEl.style.color = 'red';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Register';
        }
      } catch (error) {
        console.error('Registration error:', error);
        messageEl.textContent = 'An error occurred during registration.';
        messageEl.style.color = 'red';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register';
      }
    });
  </script>
</body>
</html>
